<!DOCTYPE html>
<html>

  <head>
    <title>Bolia bookmarks</title>
  </head>
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 2px 10px;
    }
    
    a {
      padding: 3px;
    }
  </style>
  
  <body>
    <h3>Drag and drop til bookmark bar</h3>    
    <a href="bolialinks.gif">Howto</a>
    <ul id="links">
      <li><a href="javascript:(function(){location.pathname = 'da-dk/soeg/?term=' + prompt('Søgeord')})();" title="Søg">Søg</a></li>
    </ul>
    <div>
        <h3>Brugerindtasning</h3>
        <input type="url" id="url" style="width:300px" placeholder="Url (både relativ og absolut kan bruges)" /> <input type="text" id="urlName" placeholder="Bookmarknavn" /> <input type="button" id="button" value="Gem" />
    </div>

    <script>
      /// DOM interaction
      const customLinks = document.getElementById('links');
      const url = document.getElementById('url');
      const urlName = document.getElementById('urlName');
      const button = document.getElementById('button');

      addLinkItem = (url, urlName, customId = '') => {
        url = wrapUrl(url);

        let link = document.createElement("a");
        link.href = url;
        link.title = link.text = urlName;
        link.draggable = true;
        link.onclick = (e) => e.preventDefault();

        let listItem = document.createElement("li");
        listItem.appendChild(link);
        if (customId !== '') {
          let removeLink = document.createElement("a");
          removeLink.href = "#";
          removeLink.text = "(fjern)";            
          removeLink.draggable = false;
          removeLink.onclick = (e) => {
            e.preventDefault();
            removeItem(customId);
            e.target.parentElement.remove();
          }
          listItem.appendChild(removeLink);
        }

        customLinks.appendChild(listItem);
      }

      addLinkItemFromInput = () => {
        const id = saveItem(getUrlInput(), getUrlNameInput());
        addLinkItem(getUrlInput(), getUrlNameInput(), id);        
        clearInputs();
      }

      getUrlInput = () => {
        let urlValue = url.value;
        if (getLocation(urlValue).hostname === '')
          return urlValue;
        else
          return getLocation(urlValue).pathname;
      }
      getUrlNameInput = () => urlName.value;

      clearInputs = () => {
        url.value = urlName.value = '';
      }

      // wrapUrl = (url) => `javascript:(function(){location.pathname = '${url}';})()`;
      wrapUrl = (relativePath) => `javascript:(function(){
        let url="";
        if(-1===location.hostname.indexOf("bolia")){var choice=prompt("Hvilket miljø for url: ${relativePath}\\n----------------\\n1. Dev (AX)\\n2. QA (AX)\\n3. Prod (AX)\\n----------------\\n5. Dev (D365)\\n6. QA (D365)\\n7. Prod (D365)");switch(choice){case"1":url="https://www.bolia.test/";break;case"2":url="https://boliawebsite-feature.azurewebsites.net/";break;case"3":url="https://www.bolia.com/";break;case"5":url="https://www.bolia.test/";break;case"6":url="https://bolia-com-d365-qa.azurewebsites.net";break;case"7":url="https://bolia-com-d365-prod.azurewebsites.net/";break;}}
        else {location.pathname = '${relativePath}'}
        if (url !== '') location.href = url + '${relativePath}';
        })()`;

      /// DOM helpers
      keyDownListener = function(evt) {
        if (evt.keyCode == 13) {          
          addLinkItemFromInput();
        }
      };

      getLocation = (href) => {
        let l = document.createElement("a");
        l.href = href;
        return l;
      };

      /// Localstorage handling
      saveItem = (url, urlName) => {
        const id = new Date().getTime();
        localStorage.setItem(id, JSON.stringify({url, urlName}));
        return id;
      }

      loadItems = () => {
        for (let i = 0; i < localStorage.length; i++)
        {
          const id = localStorage.key(i);
          let loadedItem = JSON.parse(localStorage.getItem(id));
          addLinkItem(loadedItem.url, loadedItem.urlName, id);
        }
      }

      removeItem = (id) => localStorage.removeItem(id);

      /// Initialization - startup with predefined urls
      addLinkItem('da-dk/produkter/01-302-04_10581467/', 'Scandinavia 2 pers');
      addLinkItem('da-dk/produkter/01-054-02_6903668/', 'Cooper 2 pers');
      addLinkItem('da-dk/produkter/24-827-02_4686/', 'Flos Glas');

      url.onkeydown = urlName.onkeydown = keyDownListener;
      button.onclick = addLinkItemFromInput;

      loadItems();
    </script>
  </body>

</html>
